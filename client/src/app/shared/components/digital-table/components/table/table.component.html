<div class="gv-flex-fh" style="flex: 1 0 0; position: relative;">

  <!-- SPINNER -->
  <div *ngIf="loading" class="gv-table-spinner">
    <mat-spinner diameter=20></mat-spinner>
  </div>

  <!-- TABLE -->
  <p-table [value]="table" [scrollable]="true" [resizableColumns]="true" columnResizeMode="expand"
    class="gv-ui-table-full-height gv-ui-table-border-cells">

    <!-- Header params for prime-ng -->
    <ng-template pTemplate="colgroup">
      <colgroup>
        <col *ngFor="let col of headers" style="width:200px">
      </colgroup>
    </ng-template>

    <!-- HEADER -->
    <ng-template pTemplate="header">
      <tr>
        <th class="gv-pointer" *ngFor="let col of headers; let i = index" (click)="sort(i)" pResizableColumn>
          <div class="gv-td-col-header">

            <!-- Column title-->
            <div class="d-flex justify-content-between" [ngClass]="{'gv-word-wrap-break-word': lineBreak}">
              <span></span>
              {{col.colLabel}}
              <!-- sort icon -->
              <span *ngIf="!(sortingEnabled && curSort.colNb == i)"></span>
              <mat-icon class="col-1" *ngIf="sortingEnabled && curSort.colNb == i"
                [svgIcon]="curSort.direction === 'ASC' ? 'arrow-down' : 'arrow-up'">
              </mat-icon>
            </div>

            <!-- Column comment-->
            <div class="d-flex justify-content-center mat-caption"
              [ngClass]="{'gv-white-space-nowrap gv-fade-out-right': !lineBreak, 'gv-word-wrap-break-word': lineBreak}">
              {{col.comment}}
            </div>

            <!-- Column name and matching-->
            <div class="d-flex row" *ngIf="col.mapping">
              <div class="col-6 text-center  mat-caption"
                [ngClass]="{'gv-white-space-nowrap': !lineBreak, 'gv-word-wrap-break-word': lineBreak}">
                Text
              </div>
              <div class="col-6 text-center mat-caption"
                [ngClass]="{'gv-white-space-nowrap': lineBreak, 'gv-word-wrap-break-word': lineBreak}">
                Matched
                <span *ngIf="col.mapping.icon === 'teEn'"
                  class="icon fa fa-star-o align-self-center gv-icon-preview"></span>
                <span *ngIf="col.mapping.icon === 'peIt'"
                  class="icon gv-icon gv-icon-persistent-entity align-self-center gv-icon-preview"></span>
                {{col.mapping.className}}
              </div>
            </div>
          </div>
        </th>
      </tr>

      <!-- FILTERING -->
      <tr class="table-row-filter" *ngIf="filteringEnabled">
        <th *ngFor="let col of headers; let i = index">
          <div class="mat-elevation-z3 gv-td-filter-box p-1">
            <gv-col-filter-text *ngIf="col.type=='string'" (filterChange)="filter(i, $event)"></gv-col-filter-text>
            <gv-col-filter-numeric *ngIf="col.type=='number'" (filterChange)="filter(i, $event)">
            </gv-col-filter-numeric>
          </div>
        </th>
      </tr>
    </ng-template>

    <!-- BODY -->
    <ng-template pTemplate="body" let-row let-i="rowIndex">
      <tr>
        <!-- <ng-container *ngFor="let value of row; let j = index" >
          <td></td>
          <td *ngIf="headers[j].mapping"></td>
        </ng-container> -->
        <td *ngFor="let value of row; let j = index" class="ui-resizable-column" (click)='cellClick(rowIndex, j)'>
          <div class="row">
            <span [ngClass]="{'gv-word-wrap-break-word': lineBreak}"
              class="col-{{headers[j].mapping ? 6 : 12}} text-center align-self-center">
              {{value}}
            </span>

            <gv-entity-matcher *ngIf="headers[j].mapping"></gv-entity-matcher>

            <!--   // MOVED TO EntityMatcherComponent -->
            <span *ngIf="entityMappings[i] ? entityMappings[i][j] : false" class="col-6 text-center align-self-center">
              <gv-entity-preview [pkEntity]="entityMappings[i][j]" [openTabOnClick]="true" [editAllowed]="true">
              </gv-entity-preview>
            </span>

            <span *ngIf="(!entityMappings[i] || (entityMappings[i] && !entityMappings[i][j])) && headers[j].mapping"
              class="col-6 text-center align-self-center">
              <mat-form-field class="w-50" appearance="outline">
                <gv-ctrl-entity [pkClass]="headers[j].mapping.fkClass" placeholder="Map to an entity" name="controlName"
                  [(ngModel)]="model" #m="ngModel" [showAddList]="true" (blur)="mappingChanged($event, i, j)">
                </gv-ctrl-entity>
                <mat-error *ngIf="m.invalid">You must enter a value</mat-error>
                <mat-icon matSuffix svgIcon="pencil"></mat-icon>
              </mat-form-field>
            </span>


          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

</div>

<ng-template #cover>
  <mat-spinner [diameter]="30"></mat-spinner>
</ng-template>

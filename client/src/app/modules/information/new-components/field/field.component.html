<!-- Field Header, in case there are multiple different lists in this field (inherited properties) -->

<div *ngIf="fieldDefinition.listType==='has-type'" class="mat-tree-node field-node">
  <!-- <button mat-icon-button disabled></button>
  <div class="bg-transparent d-flex align-items-center gv-grow-1">
    <a *ngIf="(showOntoInfo$|async)" class="badge badge-success mr-2" href="{{fieldDefinition.ontoInfoUrl}}"
      target="_blank">
      {{fieldDefinition.ontoInfoLabel}}
    </a>
    <span class="upper-case gv-field-header-label">
      {{fieldDefinition.label}}:
    </span>
    <gv-type-item class="ml-3 text-muted" [pkEntity]="pkEntity" [pkProperty]="fieldDefinition.pkProperty"
      [pkTypedClass]="fieldDefinition.sourceClass" [pkTypeClass]="fieldDefinition.listDefinitions[0]?.targetClass">
    </gv-type-item>
  </div> -->
  <div class="full-width">

    <div class="left-col">
      <div class="ellipsis">
        <a *ngIf="(showOntoInfo$|async)" class="badge badge-success mr-2" href="{{fieldDefinition.ontoInfoUrl}}"
          target="_blank">
          {{fieldDefinition.ontoInfoLabel}}
        </a>
        <span class="mat-body-strong">
          {{fieldDefinition.listDefinitions.length === 1 ? fieldDefinition.listDefinitions[0].label : fieldDefinition.label}}
          <span matTooltip="Required and not changeable (identity defining)"
            *ngIf="fieldDefinition.listDefinitions[0].isOutgoing && fieldDefinition.listDefinitions[0].isIdentityDefining">
            *
          </span>
        </span>
        <gv-type-item class="ml-3 text-muted" [pkEntity]="pkEntity" [pkProperty]="fieldDefinition.pkProperty"
          [pkTypedClass]="fieldDefinition.sourceClass" [pkTypeClass]="fieldDefinition.listDefinitions[0]?.targetClass">
        </gv-type-item>
      </div>
    </div>

    <div class="right-col">
      <button mat-icon-button [disabled]="!(showAddButton$ | async)" (click)="addClick()">
        <mat-icon>add</mat-icon>
      </button>


      <button mat-icon-button [disabled]="true">
        <mat-icon class="mat-icon-rtl-mirror">keyboard_arrow_down </mat-icon>
      </button>

    </div>
  </div>
  <mat-divider></mat-divider>
</div>

<div *ngIf="fieldDefinition.listType!=='has-type'" class="mat-tree-node field-node" [ngClass]="{
  'expanded': treeControl.isExpanded(fieldDefinition),
  'collapsed': !treeControl.isExpanded(fieldDefinition)
  }">

  <div class="full-width">

    <div class="left-col gv-pointer" matTreeNodeToggle>
      <div class="ellipsis">
        <a *ngIf="(showOntoInfo$|async)" class="badge badge-success mr-2" href="{{fieldDefinition.ontoInfoUrl}}"
          target="_blank">
          {{fieldDefinition.ontoInfoLabel}}
        </a>
        <span class="mat-body-strong">
          {{fieldDefinition.listDefinitions.length === 1 ? fieldDefinition.listDefinitions[0].label : fieldDefinition.label}}
          <span matTooltip="Required and not changeable (identity defining)"
            *ngIf="fieldDefinition.listDefinitions[0].isOutgoing && fieldDefinition.listDefinitions[0].isIdentityDefining">
            *
          </span>
        </span>
        <span class="mat-body "> ({{itemsCount$ | async}}) </span>
      </div>
    </div>

    <div class="right-col">
      <button mat-icon-button [disabled]="!(showAddButton$ | async)" (click)="addClick()">
        <mat-icon>add</mat-icon>
      </button>


      <button mat-icon-button
        (click)="treeControl.isExpanded(fieldDefinition) ? treeControl.collapse(fieldDefinition) : treeControl.expand(fieldDefinition)"
        [attr.aria-label]="'toggle ' + fieldDefinition?.label">
        <mat-icon class="mat-icon-rtl-mirror">
          {{treeControl.isExpanded(fieldDefinition) ? 'keyboard_arrow_up' : 'keyboard_arrow_down'}}
        </mat-icon>
      </button>

    </div>
  </div>
  <mat-divider *ngIf="!treeControl.isExpanded(fieldDefinition)"></mat-divider>

  <!--
  <button mat-icon-button
    (click)="treeControl.isExpanded(fieldDefinition) ? treeControl.collapse(fieldDefinition) : treeControl.expand(fieldDefinition)"
    [attr.aria-label]="'toggle ' + fieldDefinition?.label" *ngIf="(itemsCount$ | async) > 0">
    <mat-icon class="mat-icon-rtl-mirror">
      {{treeControl.isExpanded(fieldDefinition) ? 'expand_more' : 'chevron_right'}}
    </mat-icon>
  </button> -->

  <!-- <button mat-icon-button disabled *ngIf="!((itemsCount$ | async) > 0)"></button> -->

  <!-- <div class="bg-transparent d-flex align-items-center gv-grow-1">
    <a *ngIf="(showOntoInfo$|async)" class="badge badge-success mr-2" href="{{fieldDefinition.ontoInfoUrl}}"
      target="_blank">
      {{fieldDefinition.ontoInfoLabel}}
    </a>
    <span class="upper-case gv-field-header-label">
      {{fieldDefinition.listDefinitions.length === 1 ? fieldDefinition.listDefinitions[0].label : fieldDefinition.label}}
      <span matTooltip="Required and not changeable (identity defining)"
        *ngIf="fieldDefinition.listDefinitions[0].isOutgoing && fieldDefinition.listDefinitions[0].isIdentityDefining">
        *
      </span>
    </span>
    <span class="ml-1 mat-caption text-muted">
      ({{itemsCount$ | async}})
    </span>
  </div>
  <button mat-button [disabled]="!(showAddButton$ | async)" (click)="addClick()">
    <mat-icon>add_circle_outline</mat-icon> Add
  </button> -->

</div>

<span class="child-node" *ngIf="treeControl.isExpanded(fieldDefinition)">


  <div class="child-content" *ngFor="let listDefWithCount of (listsWithCounts$ |async); trackBy:getKey">

    <gv-leaf-item-list fxLayout="column"
      *ngIf="!is(listDefWithCount, 'temporal-entity') && !is(listDefWithCount, 'time-span')"
      fxLayoutAlign="space-between stretch" [listDefinition]="listDefWithCount" [treeControl]="treeControl"
      [showOntoInfo$]="showOntoInfo$" [readonly$]="readonly$" [pkEntity]="pkEntity"></gv-leaf-item-list>
    <gv-temporal-entity-list *ngIf="is(listDefWithCount, 'temporal-entity')" fxLayout="column"
      fxLayoutAlign="space-between stretch" [listDefinition]="listDefWithCount" [treeControl]="treeControl"
      [showOntoInfo$]="showOntoInfo$" [readonly$]="readonly$" [pkEntity]="pkEntity" [appContext]="appContext">
    </gv-temporal-entity-list>

    <gv-time-span-list *ngIf="is(listDefWithCount, 'time-span')" fxLayout="column" fxLayoutAlign="space-between stretch"
      [treeControl]="treeControl" [showOntoInfo$]="showOntoInfo$" [readonly$]="readonly$" [pkEntity]="pkEntity">
    </gv-time-span-list>

  </div>

  <div class="child-no-content" *ngIf="!((listsWithCounts$ |async).length > 0)">
    <i>No items</i>
  </div>

  <mat-divider></mat-divider>

</span>

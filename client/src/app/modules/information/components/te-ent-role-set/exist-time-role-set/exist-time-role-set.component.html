<!--************************* Add Pe It or Add  ************************* -->
<div *ngIf="(state$|async) === 'add-pe-it' || (state$|async) === 'add'">
  <ng-container *ngTemplateOutlet="header; context:{hideAddButton:true}"></ng-container>
  <div [@slideInOut]="(toggle$|async)">

    <div *ngFor="let entry of (roleStatesInOtherProjects$ | async) | keys; trackBy:getKey">

      <gv-te-ent-role [parentPath]="basePath" [index]="entry.key" intermediatePathSegment="roleStatesInOtherProjects">
        <div headerRight class="btn-group" ngbDropdown placement="bottom-right" class="gv-name-dropdown">

          <button class="btn btn-link" ngbDropdownToggle>
            <i class="fa fa-ellipsis-v"></i>
          </button>
          <div ngbDropdownMenu aria-labelledby="dropdown" class="dropdown-menu">

            <!-- start editing -->
            <button class="dropdown-item" (click)="startEditing(entry.key)">Edit</button>

            <!-- <button class="dropdown-item" (click)="removeFromProject(entry.key)">Remove</button> -->

          </div>
        </div>
      </gv-te-ent-role>
    </div>
  </div>
</div>

<!--************************* Editable && If this component is used a form Control ************************* -->
<div *ngIf="formControlName && ((state$|async) === 'create-pe-it-role' || (state$|async) === 'editable')">
  <ng-container *ngTemplateOutlet="header"></ng-container>

  <div [@slideInOut]="(toggle$|async)">

    <!-- If no roles in Project, show a big add button -->
    <div class="card-body" *ngIf="!(roleStatesInProject$ | async) && !((roleStatesToCreate$ | async) | keys).length && addButtonVisible">
      <button class="btn btn-outline-primary" (click)="startAddingRole()">
        Add a {{(label$ | async).sg}}
      </button>
      <button class="btn btn-link pull-right" (click)="removeRoleSet()">
        cancel
      </button>
    </div>


    <!-- Roles currently being created -->

    <form [formGroup]="formGroup" *ngIf="formGroup">

      <div class="border-top border-gray-500" *ngIf="((roleStatesToCreate$|async) | keys).length">

        <div *ngFor="let entry of (roleStatesToCreate$ | async) | keys; trackBy:getKey">
          <gv-te-ent-role *ngIf="formGroup.get(entry.key)" [parentPath]="basePath" [index]="entry.key" intermediatePathSegment="roleStatesToCreate"
            [formControlName]="entry.key" (touched)="markAsTouched()"></gv-te-ent-role>

          <div class="card-body">
            <button type="button" class="btn btn-link" (click)="cancelCreateRole(entry.key)">Cancel</button>
          </div>

        </div>
      </div>

      <!-- The roles in project -->
      <div *ngFor="let entry of (roleStatesInProject$ | async) | keys; trackBy:getKey">
        <gv-te-ent-role *ngIf="formGroup.get(entry.key)" [parentPath]="basePath" [index]="entry.key" [formControlName]="entry.key"
          (touched)="markAsTouched()">
          <div headerRight class="btn-group" ngbDropdown placement="bottom-right" class="gv-name-dropdown">

            <button class="btn btn-link" ngbDropdownToggle>
              <i class="fa fa-ellipsis-v"></i>
            </button>
            <div ngbDropdownMenu aria-labelledby="dropdown" class="dropdown-menu">

              <!-- start editing -->
              <button class="dropdown-item" (click)="startEditing(entry.key)">Edit</button>

              <button class="dropdown-item" (click)="removeFromForm()">Remove</button>

            </div>
          </div>
        </gv-te-ent-role>

        <div class="card-body" *ngIf="entry.value.state === 'create-te-ent-role'">
          <button type="button" class="btn btn-link" (click)="stopEditing(entry.key)">Cancel</button>
        </div>
      </div>

    </form>
  </div>
</div>

<!--*************************  Editable &&  If this component is not used a form Control ************************* -->
<div *ngIf="!formControlName  && (state$|async) === 'editable'">
  <ng-container *ngTemplateOutlet="header"></ng-container>

  <div [@slideInOut]="(toggle$|async)" *ngIf="!formControlName  && (state$|async) === 'editable'">

    <div *ngFor="let entry of (roleStatesInProject$ | async) | keys; trackBy:getKey">
      <gv-te-ent-role [parentPath]="basePath" [index]="entry.key">
        <div headerRight class="btn-group" ngbDropdown placement="bottom-right" class="gv-name-dropdown">

          <button class="btn btn-link" ngbDropdownToggle>
            <i class="fa fa-ellipsis-v"></i>
          </button>
          <div ngbDropdownMenu aria-labelledby="dropdown" class="dropdown-menu">

            <!-- start editing -->
            <button class="dropdown-item" (click)="startEditing(entry.key)">Edit</button>

            <!-- <button class="dropdown-item" (click)="removeFromProject(entry.key)">Remove</button> -->

          </div>
        </div>
      </gv-te-ent-role>
    </div>

  </div>
</div>





<!-- ************************** NG TEMPLATES ****************************** -->

<ng-template #header let-hideAddButton="hideAddButton">
  <div class="btn-group d-flex flex-row gv-h5">
    <button class="btn btn-light btn-sm btn-block text-left rounded-0" (click)="toggleCardBody()">
      <i class="fa fa-caret-right" [ngClass]="{'fa-rotate-90': ((toggle$|async)==='expanded')}"></i>
      <span *ngIf="(roles$ | async) && (roles$ | async).length">{{(roles$ | async)?.length}}</span>
      {{(label$ | async)?.default}}
    </button>
    <div class="gv-flex-grow-1 gv-card-spacer-x align-self-stretch d-flex" *ngIf="(ontoInfoVisible$|async)">
      <div class="align-self-center">
        <a class="badge badge-success" href="http://ontologies.dataforhistory.org/class/{{(property$|async).dfh_pk_property}}" target="_blank">
          {{(property$|async).dfh_identifier_in_namespace}}
        </a>
      </div>
    </div>
    <div class="btn btn-link btn-sm" (click)="startAddingRole()" *ngIf="addButtonVisible && !hideAddButton">
      <i class="fa fa-plus"></i>
    </div>
  </div>
</ng-template>